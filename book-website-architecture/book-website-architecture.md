# book-website-architecture
some notes and codes for the book Website Architecture.

#### 第一篇 概述
#### 第1章 大型网站架构演化
1.大型网站软件系统的特点：
(1) 高并发，大流量
(2) 高可用
(3) 海量数据
(4) 用户分布广泛，网络情况复杂
(5) 安全环境恶劣
(6) 需求快速变更，发布频繁
(7) 渐进式发展

2.大型网站架构演化发展过程：
(1) 初始阶段
应用程序、数据库、文件等所有资源在一台服务器上
(2) 应用服务和数据服务分离
分为应用服务区、数据库服务器和文件服务器
(3) 使用缓存改善网站性能
80%的业务访问集中在20%的数据上，把小部分数据缓存在内存中，减少数据库访问压力
缓存可分为应用服务器的本地缓存和专门的分布式缓存服务器
(4) 使用应用服务器集群改善网站的并发处理能力
应用服务器实现集群是网站可伸缩性架构设计中比较简单成熟的一种。
通过负载均衡调度服务器，可将用户请求分发到应用服务器集群中的任意一台服务器上，如果有更多的用户，就在集群中加入更多的应用服务器。
(5) 数据库读写分离
应用服务器在写数据的时候访问主数据库，主数据库通过主从复制将数据同步到从数据库，应用程序读数据时，可以通过从数据库获取数据。
(6) 通过反向代理和CDN加速网站响应
反向代理和CDN的原理都是缓存，区别在于CDN部署在网络提供商的机房，用户在请求网站服务时，可以从距离自己最近的网络提供商机房获取数据；反向代理部署在网站的中心机房，用户请求到达后首先访问代理服务器，如果代理服务器中缓存了用户的数据，则直接返回。
(7) 使用分布式文件系统和分布式数据库系统
分布式数据库是数据库拆分的最后手段，只有在单表规模非常大的时候才用，更常用的数据库拆分手段的业务分库，将不同业务的数据库部署到不同的物理服务器上。
(8) 使用NoSQL和搜索引擎
(9) 业务拆分
(10) 分布式服务

#### 第2章 大型网站架构模式
3.网站架构模式：
(1) 分层
分层是企业应用系统最常用的架构模式，将系统在横向维度上切分成几个部分，每个部分负责一部分职责，然后通过上层对下层的依赖和调用组成完整的系统。
(2) 分割
分割是在纵向方面对软件进行切分，将不同的功能和服务分割开来。
(3) 分布式
常见的分布式方案有：
(a) 分布式应用和服务
将分层和分割后的应用和服务模块分布式部署
(b) 分布式静态资源
静态资源独立部署，动静分离
(c) 分布式数据和存储
关系型数据库分布式部署、分布式NoSQL
(d) 分布式计算
Hadoop，MapReduce
(e) 分布式配置
支持线上服务器配置实时更新
(f) 分布式锁
分布式环境下实现并发和协同
(g) 分布式文件系统
支持云存储
(4) 集群
(5) 缓存
缓存是改善软件性能的第一手段。CDN、反向代理、本地缓存、分布式缓存。
使用缓存有两个前提条件：数据访问热点不均衡；数据在某个时间段内有效，不会很快过期
(6) 异步
单一服务内部通过多线程共享队列实现异步，分布式系统中，多个服务通过分布式消息队列实现异步，分布式消息队列可以看作是内存队列的分布式部署。
异步消息队列的特性：
(a) 提高系统可用性
(b) 加快网站响应速度
(c) 消除并发访问高峰
(7) 冗余
数据定时冷备，数据库主从热备。
(8) 自动化
自动化代码管理
自动化测试
自动化安全检测
自动化部署
自动化监控
自动化报警
自动化失效转移：将失效的服务器从集群中隔离出去
自动化失效恢复：重启服务，同步数据保证数据一致性
自动化降级：通过拒绝部分请求及关闭部分不重要的服务将负载降低到安全的水平
自动化分配资源
(9) 安全

4.新浪微博异步推拉结合的模式。
用户发表微博后将微博写入消息队列后立即返回，用户响应迅速。
消息队列消费者将微博推送给所有在线的粉丝，非在线用户登录后根据关注列表拉取微博。

#### 第3章 大型网站核心架构要素
5.大型网站核心架构要素：
(1) 性能
(2) 可用性
(3) 伸缩性
衡量架构伸缩性的主要标准是是否可以用多台服务器构建集群，是否容易向集群中添加服务器。
(4) 扩展性
衡量架构扩展性的主要标准是增加新的业务产品时，是否可以实现对现有产品无影响，不需要改动或很少改动既有业务功能就可以上线新产品。
网站可扩展架构的主要手段是事件驱动架构和分布式服务。
事件驱动架构通常用消息队列实现，可以透明的增加消息生产者和消息消费者。
分布式服务将业务和可复用服务分离开，通过分布式服务框架调用，新增产品可通过调用可复用的服务实现自身的逻辑，对现有产品无影响。
(5) 安全性

#### 第2篇
#### 第4章 瞬时响应：网站的高性能架构
6.不同视角下的网站性能：
(1) 用户
前端架构优化手段；优化HTML样式、利用浏览器的并发和异步、调整浏览器缓存策略、使用CDN、反向代理
(2) 开发
系统优化手段：使用缓存加速数据读取、使用集群提高吞吐能力、使用异步消息加快响应以及实现削峰、代码优化
(3) 运维
优化手段：建设优化骨干网、使用高性价比定制服务器、使用虚拟化技术优化资源利用

7.性能测试指标：
(1) 响应时间
(2) 并发数
系统能够同时处理请求的数目，反映了系统的负载特性。对于网站而言，并发数即网站并发用户数，指同时提交请求的用户数。
(3) 吞吐量
单位时间内系统处理的请求数量，体现系统整体的处理能力。可以用“请求数/秒”或“页面数/秒”来衡量，也可以用“访问人数/天”或“处理业务数/小时”来衡量。
TPS：每秒事务数，吞吐量的一个常用量化指标
HPS：每秒HTTP请求数
QPS：每秒查询数

8.性能测试方法：
(1) 性能测试
以系统设计规划的性能指标为预期目标，对系统施加压力，验证在资源可接收范围内，是否达到性能预期。
(2) 负载测试
对系统不断施加压力，使某项或多项性能指标达到安全临界值。
(3) 压力测试
超出安全负载的情况下，对系统继续施加压力，直到系统崩溃或者不能再处理请求，获得系统的最大压力承受能力。
(4) 稳定性测试
不均匀的对系统施加压力，使系统运行较长一段时间，检测系统是否稳定。

9.web前端性能优化：
(1) 浏览器访问优化
a.减少HTTP请求：合并css、合并JavaScript、合并图片
b.使用浏览器缓存
c.启用压缩：HTML、css、JavaScript启用GZip压缩
d.css放在页面最上面，JavaScript放在页面最下面
e.减少cookie传输：静态资源使用独立域名访问
(2) CDN加速
缓存静态资源，如图片、文件、css、script脚本、静态网页。
(3) 反向代理
配置缓存，可以是静态的资源，或者动态的热点数据

10.应用服务器性能优化
(1) 分布式缓存
(2) 异步
(3) 集群
(4) 代码优化

11.缓存使用注意事项：
a.频繁修改的数据
b.没有热点的访问
c.数据不一致与脏读
d.缓存可用性
e.缓存预热
f.缓存穿透

12.分布式缓存JBoss Cache和Memcached。
JBoss Cache: 在集群中的所有服务器都保存相同的缓存数据，某台服务器缓存数据有更新时，通知集群中其他服务器更新或清楚缓存数据。缓存数据的数量受限于单一服务器的内存空间。
Memcached: 集中式的缓存集群管理，也被称为互不通信的分布式架构。缓存与应用分离部署，应用程序通过一致性hash等路由算法选择缓存服务器访问缓存数据，缓存服务器之间不通信。
缓存集群的规模容易扩展，具有良好的伸缩性。
(1) 简单的通信协议
TCP协议，也支持UDP
(2) 丰富的客户端程序
(3) 高性能的网络通信
(4) 高效的内存管理
固定空间分配，将内存空间分为一组slab，每个slab包含一组chunk，同一个slab里chunk的大小是固定的，chunk大小相同的slab被组织在一起，称为slab_class。
保存数据时，寻找一个大于size的最小chunk。
避免了内存碎片管理的问题，内存的分配和释放都以chunk为单位。数据只能写入比它大的chunk，一个chunk只能保存一个数据，带来空间浪费。
(5) 互不通信的服务器集群架构

13.代码优化的几个方面：
(1) 多线程
从资源利用的角度看，使用多线程的原因有两个：IO阻塞和多CPU。
启动线程数 = [任务执行时间 / (任务执行时间 - IO等待时间)] x CPU内核数
解决线程安全的主要手段：
a.将对象设计为无状态对象
b.使用局部对象
c.并发访问资源时使用锁
(2) 资源复用
主要有两种模式：单例、对象池
(3) 数据结构
(4) 垃圾回收

14.存储服务器性能优化
(1) 机械硬盘和固态硬盘
(2) 数据结构：B+树和LSM树
为了改善数据访问特性，文件系统或数据库系统通常会对数据排序后再存储，加快数据检索速度，需要保证数据在更新、插入、删除后依然有序。
传统关系型数据库使用的数据结构是B+树，B+树是一种专门针对磁盘存储优化的N叉排序树。
许多NoSQL产品使用LSM树为主要的数据结构。
(3) RAID和HDFS
RAID（廉价磁盘冗余阵列）技术主要是为了改善磁盘的访问延迟，增强磁盘的可用性和容错能力。<br>

项 | 原理 | 优点 | 缺点 | 访问速度 | 数据可靠性 | 磁盘利用率
-|-|-|-|-|-|-
RAID0 | 将磁盘数量分成N分，并发写入N块磁盘。| 速度快，利用率高 | 没有备份，有一块磁盘损坏则全部损坏 | 很快 | 很低 | 100%
RAID1 | 将一份数据同时写入两块磁盘，有一块损坏可以替换修复 | 可靠性高 | 利用率低 | 很慢 | 很高 | 50%
RAID10 | RAID0和RAID1结合，将所有磁盘平均分成两份，数据同时在两份磁盘写入，相当于RAID1，同时每一份磁盘中的N/2磁盘块上，利用RAID0技术并发写入 | 速度快、可靠性高 | 利用率低，有一半用于备份。 | 中等 | 很高 | 50%
RAID3 | 将数据分成N份，并发写入N-1块磁盘，在第N块磁盘记录校验数据，任何一块磁盘损坏可利用其他N-1块磁盘修复 | 速度快、可靠、利用率高 | 第N块频繁写入，容易损坏 | 较快 | 较高 | (N-1)/N
RAID5 | 和RAID3类似，但校验数据不是写入第N块，而是螺旋式的写入所有磁盘 | RAID3的优点 | 有两块损坏无法修复 | 较快 | 较高 | (N-1)/N
RAID6 | 和RAID5类似，但数据只写入N-2块磁盘，校验数据写入2块磁盘 | RAID5的优点 | 有3块损坏无法修复 | 较快 | 较RAID5高 | (N-2)/N

HDFS（Hadoop分布式文件系统）在整个存储集群的多台服务器上进行数据并发读写和备份，可以看作在服务器集群规模上实现了类似RAID的功能。
HDFS以块（Block）为单位管理文件内容，一个文件被分割成若干个块，应用程序每写完一个块，HDFS自动将其复制到其他服务器上。

#### 第5章 万无一失：网站的高可用架构
15.


#### end.
