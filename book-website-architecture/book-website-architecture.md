# book-website-architecture
some notes and codes for the book Website Architecture(大型网站技术架构).

#### 第一篇 概述
#### 第1章 大型网站架构演化
1.大型网站软件系统的特点：<br>
(1) 高并发，大流量<br>
(2) 高可用<br>
(3) 海量数据<br>
(4) 用户分布广泛，网络情况复杂<br>
(5) 安全环境恶劣<br>
(6) 需求快速变更，发布频繁<br>
(7) 渐进式发展<br>

2.大型网站架构演化发展过程：<br>
(1) 初始阶段<br>
应用程序、数据库、文件等所有资源在一台服务器上<br>
(2) 应用服务和数据服务分离<br>
分为应用服务区、数据库服务器和文件服务器<br>
(3) 使用缓存改善网站性能<br>
80%的业务访问集中在20%的数据上，把小部分数据缓存在内存中，减少数据库访问压力<br>
缓存可分为应用服务器的本地缓存和专门的分布式缓存服务器<br>
(4) 使用应用服务器集群改善网站的并发处理能力<br>
应用服务器实现集群是网站可伸缩性架构设计中比较简单成熟的一种。<br>
通过负载均衡调度服务器，可将用户请求分发到应用服务器集群中的任意一台服务器上，如果有更多的用户，就在集群中加入更多的应用服务器。<br>
(5) 数据库读写分离<br>
应用服务器在写数据的时候访问主数据库，主数据库通过主从复制将数据同步到从数据库，应用程序读数据时，可以通过从数据库获取数据。<br>
(6) 通过反向代理和CDN加速网站响应<br>
反向代理和CDN的原理都是缓存，区别在于CDN部署在网络提供商的机房，用户在请求网站服务时，可以从距离自己最近的网络提供商机房获取数据；反向代理部署在网站的中心机房，用户请求到达后首先访问代理服务器，如果代理服务器中缓存了用户的数据，则直接返回。<br>
(7) 使用分布式文件系统和分布式数据库系统<br>
分布式数据库是数据库拆分的最后手段，只有在单表规模非常大的时候才用，更常用的数据库拆分手段的业务分库，将不同业务的数据库部署到不同的物理服务器上。<br>
(8) 使用NoSQL和搜索引擎<br>
(9) 业务拆分<br>
(10) 分布式服务

#### 第2章 大型网站架构模式
3.网站架构模式：<br>
(1) 分层<br>
分层是企业应用系统最常用的架构模式，将系统在横向维度上切分成几个部分，每个部分负责一部分职责，然后通过上层对下层的依赖和调用组成完整的系统。<br>
(2) 分割<br>
分割是在纵向方面对软件进行切分，将不同的功能和服务分割开来。<br>
(3) 分布式<br>
常见的分布式方案有：<br>
&ensp;a) 分布式应用和服务:将分层和分割后的应用和服务模块分布式部署<br>
&ensp;b) 分布式静态资源:静态资源独立部署，动静分离<br>
&ensp;c) 分布式数据和存储:关系型数据库分布式部署、分布式NoSQL<br>
&ensp;d) 分布式计算:Hadoop，MapReduce<br>
&ensp;e) 分布式配置:支持线上服务器配置实时更新<br>
&ensp;f) 分布式锁:分布式环境下实现并发和协同<br>
&ensp;g) 分布式文件系统:支持云存储<br>
(4) 集群<br>
(5) 缓存<br>
缓存是改善软件性能的第一手段。CDN、反向代理、本地缓存、分布式缓存。<br>
使用缓存有两个前提条件：数据访问热点不均衡；数据在某个时间段内有效，不会很快过期<br>
(6) 异步<br>
单一服务内部通过多线程共享队列实现异步，分布式系统中，多个服务通过分布式消息队列实现异步，分布式消息队列可以看作是内存队列的分布式部署。<br>
异步消息队列的特性：<br>
&ensp;a) 提高系统可用性<br>
&ensp;b) 加快网站响应速度<br>
&ensp;c) 消除并发访问高峰<br>
(7) 冗余<br>
数据定时冷备，数据库主从热备。<br>
(8) 自动化<br>
自动化代码管理<br>
自动化测试<br>
自动化安全检测<br>
自动化部署<br>
自动化监控<br>
自动化报警<br>
自动化失效转移：将失效的服务器从集群中隔离出去<br>
自动化失效恢复：重启服务，同步数据保证数据一致性<br>
自动化降级：通过拒绝部分请求及关闭部分不重要的服务将负载降低到安全的水平<br>
自动化分配资源<br>
(9) 安全<br>

4.新浪微博异步推拉结合的模式。<br>
用户发表微博后将微博写入消息队列后立即返回，用户响应迅速。<br>
消息队列消费者将微博推送给所有在线的粉丝，非在线用户登录后根据关注列表拉取微博。

#### 第3章 大型网站核心架构要素
5.大型网站核心架构要素：<br>
(1) 性能<br>
(2) 可用性<br>
(3) 伸缩性<br>
衡量架构伸缩性的主要标准是是否可以用多台服务器构建集群，是否容易向集群中添加服务器。<br>
(4) 扩展性<br>
衡量架构扩展性的主要标准是增加新的业务产品时，是否可以实现对现有产品无影响，不需要改动或很少改动既有业务功能就可以上线新产品。<br>
网站可扩展架构的主要手段是事件驱动架构和分布式服务。<br>
事件驱动架构通常用消息队列实现，可以透明的增加消息生产者和消息消费者。<br>
分布式服务将业务和可复用服务分离开，通过分布式服务框架调用，新增产品可通过调用可复用的服务实现自身的逻辑，对现有产品无影响。<br>
(5) 安全性

#### 第2篇
#### 第4章 瞬时响应：网站的高性能架构
6.不同视角下的网站性能：<br>
(1) 用户<br>
前端架构优化手段；优化HTML样式、利用浏览器的并发和异步、调整浏览器缓存策略、使用CDN、反向代理<br>
(2) 开发<br>
系统优化手段：使用缓存加速数据读取、使用集群提高吞吐能力、使用异步消息加快响应以及实现削峰、代码优化<br>
(3) 运维<br>
优化手段：建设优化骨干网、使用高性价比定制服务器、使用虚拟化技术优化资源利用<br>

7.性能测试指标：<br>
(1) 响应时间<br>
(2) 并发数<br>
系统能够同时处理请求的数目，反映了系统的负载特性。对于网站而言，并发数即网站并发用户数，指同时提交请求的用户数。<br>
(3) 吞吐量<br>
单位时间内系统处理的请求数量，体现系统整体的处理能力。可以用“请求数/秒”或“页面数/秒”来衡量，也可以用“访问人数/天”或“处理业务数/小时”来衡量。<br>
TPS：每秒事务数，吞吐量的一个常用量化指标<br>
HPS：每秒HTTP请求数<br>
QPS：每秒查询数<br>

8.性能测试方法：<br>
(1) 性能测试<br>
以系统设计规划的性能指标为预期目标，对系统施加压力，验证在资源可接收范围内，是否达到性能预期。<br>
(2) 负载测试<br>
对系统不断施加压力，使某项或多项性能指标达到安全临界值。<br>
(3) 压力测试<br>
超出安全负载的情况下，对系统继续施加压力，直到系统崩溃或者不能再处理请求，获得系统的最大压力承受能力。<br>
(4) 稳定性测试<br>
不均匀的对系统施加压力，使系统运行较长一段时间，检测系统是否稳定。

9.web前端性能优化：<br>
(1) 浏览器访问优化<br>
a.减少HTTP请求：合并css、合并JavaScript、合并图片<br>
b.使用浏览器缓存<br>
c.启用压缩：HTML、css、JavaScript启用GZip压缩<br>
d.css放在页面最上面，JavaScript放在页面最下面<br>
e.减少cookie传输：静态资源使用独立域名访问<br>
(2) CDN加速<br>
缓存静态资源，如图片、文件、css、script脚本、静态网页。<br>
(3) 反向代理<br>
配置缓存，可以是静态的资源，或者动态的热点数据

10.应用服务器性能优化<br>
(1) 分布式缓存<br>
(2) 异步<br>
(3) 集群<br>
(4) 代码优化<br>

11.缓存使用注意事项：<br>
a.频繁修改的数据<br>
b.没有热点的访问<br>
c.数据不一致与脏读<br>
d.缓存可用性<br>
e.缓存预热<br>
f.缓存穿透<br>

12.分布式缓存JBoss Cache和Memcached。<br>
JBoss Cache: 在集群中的所有服务器都保存相同的缓存数据，某台服务器缓存数据有更新时，通知集群中其他服务器更新或清楚缓存数据。缓存数据的数量受限于单一服务器的内存空间。<br>
Memcached: 集中式的缓存集群管理，也被称为互不通信的分布式架构。缓存与应用分离部署，应用程序通过一致性hash等路由算法选择缓存服务器访问缓存数据，缓存服务器之间不通信。<br>
缓存集群的规模容易扩展，具有良好的伸缩性。<br>
(1) 简单的通信协议<br>
TCP协议，也支持UDP<br>
(2) 丰富的客户端程序<br>
(3) 高性能的网络通信<br>
(4) 高效的内存管理<br>
固定空间分配，将内存空间分为一组slab，每个slab包含一组chunk，同一个slab里chunk的大小是固定的，chunk大小相同的slab被组织在一起，称为slab_class。<br>
保存数据时，寻找一个大于size的最小chunk。<br>
避免了内存碎片管理的问题，内存的分配和释放都以chunk为单位。数据只能写入比它大的chunk，一个chunk只能保存一个数据，带来空间浪费。<br>
(5) 互不通信的服务器集群架构<br>

13.代码优化的几个方面：<br>
(1) 多线程<br>
从资源利用的角度看，使用多线程的原因有两个：IO阻塞和多CPU。<br>
启动线程数 = [任务执行时间 / (任务执行时间 - IO等待时间)] x CPU内核数<br>
解决线程安全的主要手段：<br>
a.将对象设计为无状态对象<br>
b.使用局部对象<br>
c.并发访问资源时使用锁<br>
(2) 资源复用<br>
主要有两种模式：单例、对象池<br>
(3) 数据结构<br>
(4) 垃圾回收

14.存储服务器性能优化<br>
(1) 机械硬盘和固态硬盘<br>
(2) 数据结构：B+树和LSM树<br>
为了改善数据访问特性，文件系统或数据库系统通常会对数据排序后再存储，加快数据检索速度，需要保证数据在更新、插入、删除后依然有序。<br>
传统关系型数据库使用的数据结构是B+树，B+树是一种专门针对磁盘存储优化的N叉排序树。<br>
许多NoSQL产品使用LSM树为主要的数据结构。<br>
(3) RAID和HDFS<br>
RAID（廉价磁盘冗余阵列）技术主要是为了改善磁盘的访问延迟，增强磁盘的可用性和容错能力。<br>

项 | 原理 | 优点 | 缺点 | 访问速度 | 数据可靠性 | 磁盘利用率
-|-|-|-|-|-|-
RAID0 | 将磁盘数量分成N分，并发写入N块磁盘。| 速度快，利用率高 | 没有备份，有一块磁盘损坏则全部损坏 | 很快 | 很低 | 100%
RAID1 | 将一份数据同时写入两块磁盘，有一块损坏可以替换修复 | 可靠性高 | 利用率低 | 很慢 | 很高 | 50%
RAID10 | RAID0和RAID1结合，将所有磁盘平均分成两份，数据同时在两份磁盘写入，相当于RAID1，同时每一份磁盘中的N/2磁盘块上，利用RAID0技术并发写入 | 速度快、可靠性高 | 利用率低，有一半用于备份。 | 中等 | 很高 | 50%
RAID3 | 将数据分成N份，并发写入N-1块磁盘，在第N块磁盘记录校验数据，任何一块磁盘损坏可利用其他N-1块磁盘修复 | 速度快、可靠、利用率高 | 第N块频繁写入，容易损坏 | 较快 | 较高 | (N-1)/N
RAID5 | 和RAID3类似，但校验数据不是写入第N块，而是螺旋式的写入所有磁盘 | RAID3的优点 | 有两块损坏无法修复 | 较快 | 较高 | (N-1)/N
RAID6 | 和RAID5类似，但数据只写入N-2块磁盘，校验数据写入2块磁盘 | RAID5的优点 | 有3块损坏无法修复 | 较快 | 较RAID5高 | (N-2)/N

HDFS（Hadoop分布式文件系统）在整个存储集群的多台服务器上进行数据并发读写和备份，可以看作在服务器集群规模上实现了类似RAID的功能。<br>
HDFS以块（Block）为单位管理文件内容，一个文件被分割成若干个块，应用程序每写完一个块，HDFS自动将其复制到其他服务器上。

#### 第5章 万无一失：网站的高可用架构
15.网站的可用性（Availability）描述可有效访问的特性.

16.网站不可用也被称为网站故障，通常用多少个9来衡量网站的可用性。

17.实现高可用架构的主要手段是数据和服务的冗余备份及失效转移。

18.应用服务器集群的session管理：<br>
(1) session复制<br>
应用服务器开启web容器的session复制功能，在集群中的几台服务器之间同步session，使得每台服务器都保存所有用户的session。<br>
需要进行大量的通信进行session复制，占用服务器和网络资源；大量用户访问时可能出现内存不足。<br>
(2) session绑定<br>
利用负载均衡的源地址hash算法实现，总是将来自同一IP的请求分发到同一台服务器上。又称为会话粘滞。<br>
负载均衡服务器必须工作在HTTP协议层。<br>
某一台服务器故障，则该机器上的session丢失。<br>
(3) 利用cookie记录session<br>
受cookie大小限制；每次请求响应都需要传输，影响性能；用户关闭cookie会导致不正常<br>
(4) session服务器<br>
将应用服务器的状态分离，分为无状态的应用服务器和有状态的session服务器，针对不同的特性分别设计其架构。<br>
对于有状态的session服务器，使用分布式缓存、数据库实现。

19.高可用服务策略：<br>
(1) 分级管理<br>
区分核心应用、低优先级应用<br>
(2) 超时设置<br>
超时抛出异常，根据服务调度策略，重试或者将请求转移到其他服务。<br>
(3) 异步调用<br>
(4) 服务降级<br>
降级的两种手段：拒绝服务、关闭服务<br>
拒绝服务：拒绝低优先级应用的调用，减少服务并发数，确保核心应用正常；随机拒绝部分请求调用，节约资源，让另一部分请求成功。<br>
关闭服务：关闭部分不重要的服务，或者关闭服务内部不重要的功能，节约系统资源。<br>
(5) 幂等性设计<br>
必须在服务层保证服务重复调用和调用一次产生相同的结果。

20.保证数据存储高可用的手段主要是数据备份和失效转移。

21.CAP原理：一个提供数据服务的存储系统无法同时满足数据一致性（Consistency）、数据可用性（Availibility）、分区耐受性（Partition Tolerance，系统具有跨网络分区的伸缩性）这三个条件。<br>
在大型网站中，规模迅速扩张，因此分区耐受性必不可少，通常会选择强化可用性（A）和伸缩性（P），某种程度上放弃一致性（C）。

22.数据一致性可分为几点：<br>
(1) 强一致性<br>
各个副本的数据在物理存储中总是一致的，数据的更新操作结果和响应总是一致的，即响应失败，则一定没有更新，而不是处于不确定状态。<br>
(2) 用户一致性<br>
各个副本的数据可能是不一致的，但用户访问时，通过纠错和校验机制，可以确保返回一个一致的正确结果。<br>
(3) 最终一致性<br>
物理存储的数据可能不一致，用户访问的结果也可能不一致，但系统经过一段时间（通常是一个较短的时间）的自我恢复和修正，数据最终会达到一致。

23.数据热备的两种方式：<br>
(1) 异步热备：存储服务器分为主和从，应用只连接主存储服务器，写入成功后立即返回，通过异步线程将数据同步到从服务器。（还可用于读写分离）<br>
(2) 同步热备：多份数据副本的写入同时完成。<br>

24.数据失效转移：失效确认、访问转移、数据恢复<br>

25.灰度发布：将集群服务器分成若干部分，每次只发布一部分服务器，观察一段时间，没有故障再继续发布其他服务器。<br>
灰度发布也常用于用户测试，在一部分服务器发布新版本，收集用户体验报告，比较两个版本，以确定最终的发布版本。也称为AB测试。

26.监控数据收集：<br>
(1) 用户行为日志收集<br>
服务端日志收集<br>
客户端浏览器日志收集<br>
(2) 服务器性能监控<br>
系统load、内存占用、磁盘IO、网络IO<br>
(3) 运行数据报告<br>
缓存命中率、平均响应延迟时间等

#### 第6章 永无止境：网站的伸缩性架构
27.




#### end.
